<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link th:href="@{/styles/css/main.css}" rel="stylesheet"/>
    <title>System Logs</title>
</head>
<body>
<div th:insert="~{admin/menunavy::navy}"></div>

<div class="container-fluid mt-3">
    <h1>üìä –°–∏—Å—Ç–µ–º–Ω—ñ –ª–æ–≥–∏</h1>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5>–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Ç—ñ–≤</h5>
                    <h3 th:text="${totalLogs}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5>–£–Ω—ñ–∫–∞–ª—å–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h5>
                    <h3 th:text="${uniqueUsers}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5>–£–Ω—ñ–∫–∞–ª—å–Ω—ñ IP</h5>
                    <h3 th:text="${uniqueIPs}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5>–ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h5>
                    <h3 th:text="${todayLogs}">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <div class="card mb-3">
        <div class="card-header">
            <h5>üîç –§—ñ–ª—å—Ç—Ä–∏</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="username" class="form-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</label>
                    <input type="text" class="form-control" id="username" name="username"
                           th:value="${currentUsername}" placeholder="–í–≤–µ–¥—ñ—Ç—å username">
                </div>
                <div class="col-md-3">
                    <label for="method" class="form-label">HTTP –º–µ—Ç–æ–¥</label>
                    <select class="form-select" id="method" name="method">
                        <option value="">–í—Å—ñ –º–µ—Ç–æ–¥–∏</option>
                        <option value="GET" th:selected="${currentMethod == 'GET'}">GET</option>
                        <option value="POST" th:selected="${currentMethod == 'POST'}">POST</option>
                        <option value="PUT" th:selected="${currentMethod == 'PUT'}">PUT</option>
                        <option value="DELETE" th:selected="${currentMethod == 'DELETE'}">DELETE</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="role" class="form-label">–†–æ–ª—å</label>
                    <select class="form-select" id="role" name="role">
                        <option value="">–í—Å—ñ —Ä–æ–ª—ñ</option>
                        <option value="ROLE_ADMIN" th:selected="${currentRole == 'ROLE_ADMIN'}">ADMIN</option>
                        <option value="ROLE_USER" th:selected="${currentRole == 'ROLE_USER'}">USER</option>
                        <option value="ANONYMOUS" th:selected="${currentRole == 'ANONYMOUS'}">ANONYMOUS</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
                    <a th:href="@{/admin/logs}" class="btn btn-outline-secondary">–°–∫–∏–Ω—É—Ç–∏</a>
                </div>
            </form>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü—è –ª–æ–≥—ñ–≤ -->
    <div class="card">
        <div class="card-header">
            <h5>üìã –ñ—É—Ä–Ω–∞–ª –∑–∞–ø–∏—Ç—ñ–≤ (–Ω–∞–π–Ω–æ–≤—ñ—à—ñ –ø–µ—Ä—à–∏–º–∏)</h5>
            <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ <span th:text="${#lists.size(logs)}">0</span> –∑ <span th:text="${totalLogs}">0</span> –∑–∞–ø–∏—Å—ñ–≤</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th>–ß–∞—Å</th>
                        <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                        <th>–†–æ–ª—å</th>
                        <th>–ú–µ—Ç–æ–¥</th>
                        <th>–®–ª—è—Ö</th>
                        <th>IP –∞–¥—Ä–µ—Å–∞</th>
                        <th>User Agent</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="log : ${logs}">
                        <td>
                            <div th:text="${#temporals.format(log.timestamp, 'dd.MM.yyyy')}"></div>
                            <small class="text-muted" th:text="${#temporals.format(log.timestamp, 'HH:mm:ss')}"></small>
                        </td>
                        <td>
                            <span th:if="${log.username == 'ANONYMOUS'}" class="badge bg-secondary">–ê–Ω–æ–Ω—ñ–º</span>
                            <span th:if="${log.username == 'INVALID_TOKEN'}" class="badge bg-danger">–ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω</span>
                            <span th:unless="${log.username == 'ANONYMOUS' or log.username == 'INVALID_TOKEN'}"
                                  th:text="${log.username}"></span>
                        </td>
                        <td>
                            <span th:if="${log.role == 'ROLE_ADMIN'}" class="badge bg-danger">ADMIN</span>
                            <span th:if="${log.role == 'ROLE_USER'}" class="badge bg-success">USER</span>
                            <span th:if="${log.role == null or log.role == ''}" class="badge bg-secondary">NONE</span>
                            <span th:unless="${log.role == 'ROLE_ADMIN' or log.role == 'ROLE_USER' or log.role == null or log.role == ''}"
                                  class="badge bg-info" th:text="${log.role}"></span>
                        </td>
                        <td>
                            <span th:if="${log.method == 'GET'}" class="badge bg-success" th:text="${log.method}"></span>
                            <span th:if="${log.method == 'POST'}" class="badge bg-primary" th:text="${log.method}"></span>
                            <span th:if="${log.method == 'PUT'}" class="badge bg-warning" th:text="${log.method}"></span>
                            <span th:if="${log.method == 'DELETE'}" class="badge bg-danger" th:text="${log.method}"></span>
                            <span th:unless="${log.method == 'GET' or log.method == 'POST' or log.method == 'PUT' or log.method == 'DELETE'}"
                                  class="badge bg-secondary" th:text="${log.method}"></span>
                        </td>
                        <td>
                            <code th:text="${log.path}"></code>
                        </td>
                        <td>
                            <span th:text="${log.clientIp}"></span>
                        </td>
                        <td>
                            <small th:text="${#strings.abbreviate(log.userAgent, 50)}" th:title="${log.userAgent}"></small>
                        </td>
                    </tr>

                    <!-- –Ø–∫—â–æ –Ω–µ–º–∞—î –ª–æ–≥—ñ–≤ -->
                    <tr th:if="${#lists.isEmpty(logs)}">
                        <td colspan="7" class="text-center text-muted py-4">
                            –õ–æ–≥–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
    <div class="d-flex justify-content-between align-items-center mt-3" th:if="${totalPages > 1}">
        <div class="text-muted">
            –°—Ç–æ—Ä—ñ–Ω–∫–∞ <span th:text="${currentPage + 1}">1</span> –∑ <span th:text="${totalPages}">1</span>
        </div>
        <nav>
            <ul class="pagination">
                <!-- –ü–æ–ø–µ—Ä–µ–¥–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ -->
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/admin/logs(page=${currentPage - 1}, username=${currentUsername}, method=${currentMethod}, role=${currentRole})}">
                        –ü–æ–ø–µ—Ä–µ–¥–Ω—è
                    </a>
                </li>

                <!-- –ù–æ–º–µ—Ä–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ -->
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                       th:href="@{/admin/logs(page=${i}, username=${currentUsername}, method=${currentMethod}, role=${currentRole})}"
                       th:text="${i + 1}"></a>
                </li>

                <!-- –ù–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ -->
                <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/admin/logs(page=${currentPage + 1}, username=${currentUsername}, method=${currentMethod}, role=${currentRole})}">
                        –ù–∞—Å—Ç—É–ø–Ω–∞
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∞–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ -->
    <div th:if="${hasActiveFilters}" class="alert alert-info mt-3">
        <strong>–ê–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏:</strong>
        <span th:if="${currentUsername}" class="badge bg-primary me-1">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: <span th:text="${currentUsername}"></span></span>
        <span th:if="${currentMethod}" class="badge bg-success me-1">–ú–µ—Ç–æ–¥: <span th:text="${currentMethod}"></span></span>
        <span th:if="${currentRole}" class="badge bg-warning me-1">–†–æ–ª—å: <span th:text="${currentRole}"></span></span>
    </div>

    <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É -->
    <div th:if="${errorMessage}" class="alert alert-danger mt-3">
        <strong>–ü–æ–º–∏–ª–∫–∞:</strong> <span th:text="${errorMessage}"></span>
    </div>

</div>

<div th:insert="~{footer::footer}"></div>

<!-- –ü—Ä–æ—Å—Ç–∏–π CSS –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≤–∏–≥–ª—è–¥—É -->
<style>
    .table th {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }

    .badge {
        font-size: 0.75rem;
    }

    code {
        font-size: 0.8rem;
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        color: #495057;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .table-responsive {
        max-height: 70vh;
        overflow-y: auto;
    }

    .pagination .page-link {
        color: #0d6efd;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∏—Ö –∫–∞—Ä—Ç–æ–∫ */
    .card {
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .card h3 {
        margin: 0;
        font-weight: bold;
    }

    .card h5 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        opacity: 0.9;
    }

    /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ —Ç–∞–±–ª–∏—Ü—ñ */
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f8f9fa;
    }

    .table-hover tbody tr:hover {
        background-color: #e9ecef;
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ */
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 10px;
        }

        .table-responsive {
            font-size: 0.8rem;
        }

        .card-body {
            padding: 1rem;
        }
    }
</style>

</body>
</html>
